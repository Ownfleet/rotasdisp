<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rotas ‚Ä¢ Admin</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  :root{
    --brand:#ff5a2a; --brand-2:#ff713f; --brand-3:#ff3e0e;
    --ink:#0e1320; --muted:#6c7282;
    --bg:#f6f7fb; --grad-a:#ffeae1; --grad-b:#ffe0d4;
    --card:rgba(255,255,255,.78); --line:rgba(110,120,150,.12);
    --blur:12px; --shadow-lg:0 30px 60px rgba(15,23,42,.12), 0 10px 20px rgba(15,23,42,.06);
    --shadow-sm:0 12px 24px rgba(15,23,42,.08);
    --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    --r-card:26px; --r-btn:12px;
    --pill-ok-bg:#e8fbf1; --pill-ok-bd:#c7f1da; --pill-ok-tx:#0a7a57;
    --pill-warn-bg:#fff3cd; --pill-warn-bd:#ffe29a; --pill-warn-tx:#8a6b00;
    --btn-ghost-bd:rgba(255,255,255,.3); --header-shadow:0 12px 28px rgba(255,90,42,.22);
    --modal-surface:rgba(255,255,255,.9); --modal-line:rgba(15,23,42,.08);
  }
  [data-theme="dark"]{
    --ink:#e7ecff; --muted:#97a0b8;
    --bg:#0b1020; --grad-a:#1a223a; --grad-b:#131a2f;
    --card:rgba(20,26,44,.72); --line:rgba(180,200,255,.10);
    --shadow-lg:0 30px 60px rgba(0,0,0,.35), 0 10px 20px rgba(0,0,0,.25);
    --shadow-sm:0 12px 22px rgba(0,0,0,.28);
    --pill-ok-bg:rgba(16,185,129,.12); --pill-ok-bd:rgba(16,185,129,.25); --pill-ok-tx:#7ee0ba;
    --pill-warn-bg:rgba(245,158,11,.12); --pill-warn-bd:rgba(245,158,11,.28); --pill-warn-tx:#ffd391;
    --btn-ghost-bd:rgba(255,255,255,.20); --header-shadow:0 12px 28px rgba(0,0,0,.55);
    --modal-surface:rgba(22,28,48,.92); --modal-line:rgba(200,210,255,.10);
  }

  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font:15px/1.48 Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background:
      radial-gradient(1000px 600px at 15% -10%, var(--grad-a) 0, rgba(0,0,0,0) 55%),
      radial-gradient(900px 600px at 110% 0%, var(--grad-b) 0, rgba(0,0,0,0) 50%),
      var(--bg);
  }

  .appbar{position:sticky; top:0; z-index:30; background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; box-shadow:var(--header-shadow)}
  .appbar .inner{max-width:1200px; margin:0 auto; padding:16px 20px; display:flex; align-items:center; gap:14px; flex-wrap:wrap}

  .logo{display:flex; align-items:center; gap:12px; font-weight:900}
  .logo .badge{
    display:flex; align-items:center; justify-content:center;
    height:40px; padding:0 10px; border-radius:14px;
    background:#fff; box-shadow:inset 0 0 0 2px rgba(255,255,255,.4), 0 6px 20px rgba(0,0,0,.15);
  }
  .logo img.brand{height:24px; width:auto; display:block; object-fit:contain}

  .spacer{flex:1}
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 16px; border-radius:var(--r-btn); border:1px solid var(--btn-ghost-bd); background:#fff; color:var(--brand-3); font-weight:800; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.06); transition:transform .06s, box-shadow .15s}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0) scale(.98)}
  .btn.ghost{background:transparent; color:#fff}
  .btn.small{padding:8px 12px}
  .toggle{border-color:var(--btn-ghost-bd);}

  .badge{
    display:inline-block; min-width:22px; padding:2px 8px; border-radius:999px;
    background:#fff; color:#ff3e0e; font-weight:900; text-align:center; border:1px solid var(--btn-ghost-bd);
  }

  .wrap{max-width:1200px; margin:26px auto; padding:0 20px}

  .login{
    background:var(--card); border:1px solid var(--line); border-radius:22px;
    padding:18px; box-shadow:var(--shadow-lg); max-width:560px; margin:28px auto;
    backdrop-filter: blur(12px);
  }
  label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}

  input[type=password], input[type=text], select{
    width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:14px;
    background:rgba(255,255,255,.9); outline:none;
  }
  [data-theme="dark"] input[type=password],
  [data-theme="dark"] input[type=text],
  [data-theme="dark"] select{background:rgba(255,255,255,.06); color:var(--ink)}
  input:focus, select:focus{box-shadow:0 0 0 3px rgba(255,90,42,.18); border-color:rgba(255,90,42,.45)}
  .hint{margin-top:8px; color:var(--muted)}

  .section h2{margin:0 0 14px; font-size:22px}
  .card{
    position:relative; isolation:isolate;
    border-radius:var(--r-card); background:var(--card); border:1px solid var(--line);
    box-shadow:var(--shadow-lg); backdrop-filter: blur(12px);
    padding:16px; margin-bottom:16px;
  }
  .row{display:grid; grid-template-columns: 1.2fr .9fr .9fr; gap:12px; align-items:center}
  .route{display:flex; flex-direction:column; gap:6px}
  .title{font-weight:900; font-size:16px}
  .subtitle{color:var(--muted)}
  .muted{color:var(--muted)}

  .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; font-weight:900; font-size:12px; border:1px solid}
  .pill.ok{background:var(--pill-ok-bg); border-color:var(--pill-ok-bd); color:var(--pill-ok-tx)}
  .pill.warn{background:var(--pill-warn-bg); border-color:var(--pill-warn-bd); color:var(--pill-warn-tx)}
  .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
  .btn-action{padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:#fff; color:#1c2437; font-weight:800; cursor:pointer; box-shadow:var(--shadow-sm)}
  [data-theme="dark"] .btn-action{background:rgba(255,255,255,.06); color:var(--ink)}
  .btn-action.primary{border-color:#ffd8cc; background:linear-gradient(#fff,#fff7f5); color:var(--brand-3)}
  [data-theme="dark"] .btn-action.primary{background:linear-gradient(rgba(255,255,255,.07),rgba(255,255,255,.05))}
  .btn-action.danger{border-color:#ffd7d7; background:linear-gradient(#fff,#fff7f7); color:#b91c1c}
  [data-theme="dark"] .btn-action.danger{background:linear-gradient(rgba(255,255,255,.07),rgba(255,255,255,.05)); color:#ffb3b3}
  .btn-action:disabled{opacity:.55; filter:grayscale(.15); cursor:not-allowed; box-shadow:none}

  .backdrop{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80; background:rgba(5,10,25,.55); backdrop-filter: blur(8px)}
  .modal{width:min(720px, 92vw); background:var(--card); border:1px solid var(--line); border-radius:24px; box-shadow:var(--shadow-lg); overflow:hidden; animation:pop .16s ease}
  @keyframes pop{from{transform:translateY(8px); opacity:0} to{transform:none; opacity:1}}
  .modal .head{background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.65)); padding:16px 18px; display:flex; align-items:center; justify-content:space-between}
  [data-theme="dark"] .modal .head{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04))}
  .modal .body{padding:18px}
  .modal .foot{padding:16px 18px; display:flex; gap:10px; justify-content:flex-end; background:linear-gradient(0deg,rgba(255,255,255,.85),rgba(255,255,255,.65))}
  [data-theme="dark"] .modal .foot{background:linear-gradient(0deg,rgba(255,255,255,.08),rgba(255,255,255,.04))}
  .checks{display:flex; gap:12px; flex-wrap:wrap; margin-top:8px}
  .check{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff}
  [data-theme="dark"] .check{background:rgba(255,255,255,.06); color:var(--ink)}

  .dialog{width:min(520px,90vw); background:var(--modal-surface); border:1px solid var(--modal-line); border-radius:20px; box-shadow:var(--shadow-lg); overflow:hidden; animation:pop .14s ease}
  .dialog .h{padding:14px 16px; font-weight:900; border-bottom:1px solid var(--modal-line)}
  .dialog .c{padding:16px}
  .dialog .f{padding:12px 16px; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid var(--modal-line); background:linear-gradient(0deg,rgba(255,255,255,.85),rgba(255,255,255,.65))}
  [data-theme="dark"] .dialog .f{background:linear-gradient(0deg,rgba(255,255,255,.06),rgba(255,255,255,.03))}
  .btn-ghost{background:transparent; border:1px solid var(--line); color:var(--ink); padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer}
  .btn-danger{background:linear-gradient(180deg,#ff8a70,#ff5a2a); color:#fff; border:none; padding:10px 16px; border-radius:12px; font-weight:900; cursor:pointer}
  .btn-primary{background:linear-gradient(180deg,#ff7a58,#ff5a2a); color:#fff; border:none; padding:10px 16px; border-radius:12px; font-weight:900; cursor:pointer}

  .empty{display:none; margin:18px 0; padding:20px; border-radius:18px; border:1px dashed var(--line); color:var(--muted); background:rgba(255,255,255,.06)}
  .hide{display:none!important}

  /* ‚úÖ FIX: ordem de camadas (dialog sempre acima) */
  #backdrop{ z-index:1500 !important; }
  #driversBackdrop{ z-index:2000 !important; }
  #driverBackdrop{ z-index:2100 !important; }
  #dialogBackdrop{ z-index:9999 !important; }
</style>
</head>
<body>

<header class="appbar">
  <div class="inner">
    <div class="logo">
      <span class="badge">
        <img class="brand" src="https://wp.logos-download.com/wp-content/uploads/2024/09/Shopee_Express_Logo-3000x474.png" alt="Shopee Express">
      </span>
      <div>Rotas ‚Ä¢ <b>Admin</b></div>
    </div>
    <div class="spacer"></div>

    <button class="btn ghost small" id="btnShowPresent">
      Dispon√≠veis no galp√£o <span id="presentCount" class="badge">0</span>
    </button>

    <button class="btn ghost small" id="btnClearPresent">Limpar dispon√≠veis</button>
    <button class="btn ghost small" id="btnShowDrivers">Motoristas</button>

    <button id="btnTheme" class="btn ghost small toggle" title="Alternar tema">üåô Escuro</button>
    <button class="btn ghost small hide" id="btnLogout">Sair</button>
    <button class="btn hide" id="btnOpenModal">Nova rota</button>
  </div>
</header>

<main class="wrap">
  <!-- Login -->
  <section id="loginBox" class="login">
    <h3 style="margin:0 0 10px">Acesso restrito</h3>
    <label for="adminPass">Senha</label>
    <input id="adminPass" type="password" placeholder="Digite a senha do painel">
    <label style="display:flex;align-items:center;gap:8px;margin-top:10px;user-select:none">
      <input type="checkbox" id="rememberPass" checked> Lembrar senha neste dispositivo
    </label>
    <div style="display:flex;gap:10px;margin-top:14px">
      <button class="btn" id="btnLogin">Entrar</button>
      <div id="msgLogin" class="hint"></div>
    </div>
  </section>

  <!-- Painel -->
  <section id="panel" class="section hide">
    <h2>Rotas publicadas</h2>
    <div id="empty" class="empty">Nenhuma rota publicada ainda.</div>
    <div id="list"></div>

    <section id="presentSec" class="section">
      <h2>Dispon√≠veis no galp√£o <span class="muted" id="presentHint"></span></h2>
      <div id="presentEmpty" class="empty">Ningu√©m se disponibilizou recentemente.</div>
      <div id="presentList"></div>
    </section>
  </section>
</main>

<!-- Modal Nova Rota -->
<div class="backdrop" id="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="head">
      <h3 id="modalTitle" style="margin:0">Divulgar nova rota</h3>
      <button class="btn ghost small" id="btnCloseModal" title="Fechar">‚úï</button>
    </div>
    <div class="body">
      <div class="row" style="grid-template-columns:1fr 1fr; gap:14px">
        <div>
          <label for="cluster">Rota</label>
          <input id="cluster" type="text" placeholder="ex.: A-3">
        </div>
        <div>
          <label for="region">Regi√£o</label>
          <input id="region" type="text" placeholder="ex.: Jardim Santa Cec√≠lia">
        </div>
      </div>
      <div style="margin-top:14px">
        <label>Tipos permitidos</label>
        <div class="checks">
          <label class="check"><input type="checkbox" class="veh" value="MOTO" checked> Moto</label>
          <label class="check"><input type="checkbox" class="veh" value="FIORINO" checked> Fiorino</label>
          <label class="check"><input type="checkbox" class="veh" value="PASSEIO" checked> Passeio</label>
        </div>
      </div>
    </div>
    <div class="foot">
      <button class="btn ghost" id="btnCancel">Cancelar</button>
      <button class="btn" id="btnCreate">Divulgar</button>
    </div>
  </div>
</div>

<!-- Dialog (alert/confirm) -->
<div class="backdrop" id="dialogBackdrop">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
    <div class="h" id="dlgTitle">T√≠tulo</div>
    <div class="c" id="dlgContent">Mensagem</div>
    <div class="f" id="dlgActions"></div>
  </div>
</div>

<!-- Modal Motoristas -->
<div class="backdrop" id="driversBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="driversTitle">
    <div class="head">
      <h3 id="driversTitle" style="margin:0">Motoristas</h3>
      <button class="btn ghost small" id="btnCloseDrivers" title="Fechar">‚úï</button>
    </div>

    <div class="body">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
        <input id="driversQuery" type="text" placeholder="Pesquisar por ID ou nome..." style="flex:1; min-width:240px">
        <button class="btn" id="btnSearchDrivers">Pesquisar</button>
        <button class="btn ghost" id="btnNewDriverTop">Adicionar</button>
      </div>

      <div class="hint" id="driversHint" style="margin-top:10px">
        Digite um ID ou nome e clique em Pesquisar.
      </div>

      <div id="driversSearchEmpty" class="empty">Nenhum motorista encontrado.</div>
      <div id="driversSearchList" style="margin-top:12px"></div>
    </div>

    <div class="foot">
      <button class="btn ghost" id="btnCloseDrivers2">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal Adicionar Motorista -->
<div class="backdrop" id="driverBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="driverModalTitle">
    <div class="head">
      <h3 id="driverModalTitle" style="margin:0">Adicionar motorista</h3>
      <button class="btn ghost small" id="btnCloseDriver" title="Fechar">‚úï</button>
    </div>
    <div class="body">
      <div class="row" style="grid-template-columns:1fr 1fr; gap:14px">
        <div>
          <label for="d_id">Driver ID</label>
          <input id="d_id" type="text" placeholder="ex.: 2342923">
        </div>
        <div>
          <label for="d_vehicle">Ve√≠culo</label>
          <!-- ‚úÖ VAN removida -->
          <select id="d_vehicle">
            <option value="" selected disabled>Selecione...</option>
            <option value="MOTO">MOTO</option>
            <option value="FIORINO">FIORINO</option>
            <option value="PASSEIO">PASSEIO</option>
          </select>
        </div>
      </div>
      <div style="margin-top:14px">
        <label for="d_name">Nome</label>
        <input id="d_name" type="text" placeholder="Nome completo">
      </div>
      <div class="hint" id="driverModalHint" style="margin-top:10px"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" id="btnCancelDriver">Cancelar</button>
      <button class="btn" id="btnSaveDriver">Salvar</button>
    </div>
  </div>
</div>

<script>
/* ========= THEME ========= */
(function initTheme(){
  const saved = localStorage.getItem('theme');
  const root = document.documentElement;
  if(saved === 'light' || saved === 'dark') root.setAttribute('data-theme', saved);
  const btn = document.getElementById('btnTheme');
  const sync = () => { btn.textContent = root.getAttribute('data-theme') === 'dark' ? 'üåô Escuro' : '‚òÄÔ∏è Claro'; };
  sync();
  btn.onclick = () => {
    const cur = root.getAttribute('data-theme');
    const next = cur === 'dark' ? 'light' : 'dark';
    root.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    sync();
  };
})();

/* ========= CONFIG ========= */
const SUPABASE_URL = 'https://rtuxwydhgucdqbmyuhbt.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0dXh3eWRoZ3VjZHFibXl1aGJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTQyOTEsImV4cCI6MjA3NTM5MDI5MX0._69KQdPbipke-jVmF_UEO3VAYaiEqpa1h81jUVTN684';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ========= HELPERS ========= */
const $ = s => document.querySelector(s);

/* ----- Dialog system ----- */
function openDialog({title, message, actions}) {
  return new Promise(resolve=>{
    const bd = $('#dialogBackdrop');
    const t = $('#dlgTitle'); const c = $('#dlgContent'); const f = $('#dlgActions');
    t.textContent = title || '';
    c.innerHTML = message || '';
    f.innerHTML = '';

    const cleanup = ()=>{
      bd.style.display='none';
      window.removeEventListener('keydown', onKey);
    };

    actions.forEach(a=>{
      const b = document.createElement('button');
      b.textContent = a.label;
      b.className = a.variant || 'btn-primary';
      b.onclick = ()=>{ cleanup(); resolve(a.value); };
      f.appendChild(b);
    });

    bd.style.display='flex';

    const onKey = (e)=>{
      if(e.key==='Escape'){
        cleanup();
        resolve(actions[0]?.value ?? null);
      }
    };
    window.addEventListener('keydown', onKey);
  });
}
const modalAlert = (title, msg, ok='OK') =>
  openDialog({title, message: msg, actions:[{label:ok, value:true, variant:'btn-primary'}]});
const modalConfirm = (title, msg, ok='Confirmar', cancel='Cancelar', danger=false) =>
  openDialog({title, message: msg, actions:[
    {label:cancel, value:false, variant:'btn-ghost'},
    {label:ok, value:true, variant: danger?'btn-danger':'btn-primary'}
  ]});

/* ========= STATE ========= */
let channelRoutes=null;
let channelPresent=null;
let adminHash=null;

/* ========= LOGIN ========= */
async function sha256(text){
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function checkPassword(pass){
  const hash = await sha256(pass);
  const { data, error } = await sb.from('config').select('admin_pass').eq('id',1).single();
  if(error) return false;
  const ok = data?.admin_pass === hash;
  if(ok) adminHash = hash;
  return ok;
}
function setLoggedUI(on){
  $('#panel').classList.toggle('hide', !on);
  $('#btnOpenModal').classList.toggle('hide', !on);
  $('#btnLogout').classList.toggle('hide', !on);
  $('#loginBox').classList.toggle('hide', on);
}
(function autologin(){
  const saved = localStorage.getItem('admin_access');
  const savedHash = localStorage.getItem('admin_hash');
  if(saved === 'ok' && savedHash){
    adminHash = savedHash;
    setLoggedUI(true);
    initPanel();
  }
})();
$('#btnLogin').onclick = async ()=>{
  const p = $('#adminPass').value.trim();
  const remember = document.getElementById('rememberPass').checked;
  if(!p){ document.getElementById('msgLogin').textContent='Digite a senha'; return; }
  const ok = await checkPassword(p);
  if(ok){
    setLoggedUI(true);
    if(remember){
      localStorage.setItem('admin_access','ok');
      localStorage.setItem('admin_hash', adminHash);
    }
    await modalAlert('Bem-vindo üëã','Acesso concedido.');
    await initPanel();
  } else {
    await modalAlert('Erro','Senha incorreta.');
  }
};
document.getElementById('adminPass').addEventListener('keydown',e=>{
  if(e.key==='Enter') document.getElementById('btnLogin').click();
});

document.getElementById('btnLogout').onclick = async ()=>{
  const sure = await modalConfirm('Sair', 'Deseja encerrar a sess√£o?', 'Sair', 'Cancelar', true);
  if(!sure) return;
  adminHash=null;
  localStorage.removeItem('admin_access'); localStorage.removeItem('admin_hash');
  setLoggedUI(false); document.getElementById('adminPass').value='';
  await modalAlert('Pronto','Sess√£o encerrada.');
};

/* ========= MODAL NOVA ROTA ========= */
function openModal(){
  if(!adminHash){ modalAlert('Acesso','Fa√ßa login para divulgar.'); return; }
  document.getElementById('backdrop').style.display='flex';
  document.getElementById('cluster').focus();
}
function closeModal(){ document.getElementById('backdrop').style.display='none'; }
(function bindModalButtons(){
  const btnOpen = document.getElementById('btnOpenModal');
  if(btnOpen) btnOpen.addEventListener('click', e=>{ e.preventDefault(); openModal(); });
  const btnClose = document.getElementById('btnCloseModal');
  if(btnClose) btnClose.onclick = closeModal;
  const btnCancel = document.getElementById('btnCancel');
  if(btnCancel) btnCancel.onclick = closeModal;
  const bd = document.getElementById('backdrop');
  if(bd) bd.addEventListener('click', e=>{ if(e.target.id==='backdrop') closeModal(); });
})();

/* ========= LISTA (ROTAS) ========= */
const fmtAllowed = arr => (arr||[]).join(', ');
async function loadRoutes(){
  const { data, error } = await sb.from('routes')
    .select('id,cluster,region,vehicle_allowed,claimed_driver_id,created_at')
    .order('created_at',{ascending:false});
  if(error){ console.error(error); await modalAlert('Erro','Falha ao carregar rotas.'); return []; }
  return data||[];
}
async function resolveDriverName(id){
  if(!id) return '';
  const { data } = await sb.from('drivers').select('name').eq('driver_id',id).single();
  return data?.name || '';
}
async function renderRoutes(rows){
  const container = document.getElementById('list');
  const empty = document.getElementById('empty');
  container.innerHTML='';
  if(!rows.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  for(const r of rows){
    const claimed = !!r.claimed_driver_id;
    const who = claimed ? `[${r.claimed_driver_id}] ${await resolveDriverName(r.claimed_driver_id)}` : '';
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="row">
        <div class="route">
          <div class="title">${r.cluster||'-'}</div>
          <div class="subtitle">${r.region||''}</div>
          <div class="muted">Permitidos: ${fmtAllowed(r.vehicle_allowed)}</div>
        </div>
        <div>
          ${claimed
            ? `<span class="pill ok">Rota repassada</span><div class="muted" style="margin-top:6px">${who||''}</div>`
            : `<span class="pill warn">Dispon√≠vel</span><div class="muted" style="margin-top:6px">Criada: ${new Date(r.created_at).toLocaleString()}</div>`
          }
        </div>
        <div class="actions">
          <button class="btn-action primary" data-action="open" data-id="${r.id}" ${claimed?'':'disabled'}>Abrir (dispon√≠vel)</button>
          <button class="btn-action danger" data-action="delete" data-id="${r.id}">Excluir</button>
        </div>
      </div>
    `;
    container.appendChild(card);
  }
  container.querySelectorAll('.btn-action').forEach(btn=>{
    btn.onclick = async ()=>{
      if(!adminHash){ await modalAlert('Acesso','Fa√ßa login para executar.'); return; }
      const id = Number(btn.dataset.id);
      const act = btn.dataset.action;
      if(act==='open'){
        const ok = await modalConfirm('Abrir rota', 'Deseja reabrir esta rota e torn√°-la dispon√≠vel novamente?', 'Abrir', 'Cancelar');
        if(!ok) return;
        const { data, error } = await sb.rpc('admin_open_route', { p_route_id:id, p_passhash: adminHash });
        if(error){ await modalAlert('Erro', error.message || 'Falha ao abrir.'); return; }
        await modalAlert('Sucesso', (data && data[0]?.message) || 'Rota aberta.');
      }
      if(act==='delete'){
        const ok = await modalConfirm('Excluir rota', 'Tem certeza que deseja excluir esta rota?', 'Excluir', 'Cancelar', true);
        if(!ok) return;
        const { data, error } = await sb.rpc('admin_delete_route', { p_route_id:id, p_passhash: adminHash });
        if(error){ await modalAlert('Erro', error.message || 'Falha ao excluir.'); return; }
        await modalAlert('Exclu√≠da', (data && data[0]?.message) || 'Rota exclu√≠da.');
      }
    };
  });
}

/* ========= CRIAR ROTA ========= */
document.getElementById('btnCreate').onclick = async ()=>{
  if(!adminHash){ await modalAlert('Acesso','Fa√ßa login para divulgar.'); return; }
  const cluster = document.getElementById('cluster').value.trim();
  const region  = document.getElementById('region').value.trim();
  const veh = [...document.querySelectorAll('.veh:checked')].map(i=>i.value);
  if(!cluster || !region || !veh.length){
    await modalAlert('Campos obrigat√≥rios','Preencha rota, regi√£o e tipos permitidos.');
    return;
  }
  const { data, error } = await sb.rpc('admin_create_route', {
    p_cluster: cluster, p_region: region, p_vehicle: veh, p_passhash: adminHash
  });
  if(error){ await modalAlert('Erro', error.message || 'Falha ao divulgar.'); return; }
  document.getElementById('cluster').value=''; document.getElementById('region').value='';
  document.querySelectorAll('.veh').forEach(c=>c.checked=true);
  closeModal();
  await modalAlert('Publicado', (data && data[0]?.message) || 'Rota divulgada.');
};

/* ========= PRESENTES ========= */
const PRESENT_WINDOW_MIN = 120;
async function fetchPresent(){
  const { data, error } = await sb.rpc('get_present_drivers');
  if(error){ console.error(error); return []; }
  const seen = new Set(); const latest=[];
  for(const r of data){ if(!seen.has(r.driver_id)){ seen.add(r.driver_id); latest.push(r); } }
  return latest;
}
function fmtTime(ts){
  try{ return new Date(ts).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); }
  catch(_){ return ''; }
}
async function renderPresent(){
  const listEl  = document.getElementById('presentList');
  const emptyEl = document.getElementById('presentEmpty');
  const hintEl  = document.getElementById('presentHint');
  listEl.innerHTML = '';
  const rows = await fetchPresent();
  document.getElementById('presentCount').textContent = String(rows.length);
  hintEl.textContent = rows.length ? `‚Ä¢ √∫ltimos ${PRESENT_WINDOW_MIN} min` : '';
  if(!rows.length){ emptyEl.style.display='block'; return; }
  emptyEl.style.display='none';
  for(const r of rows){
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="row" style="grid-template-columns: 1.4fr .8fr .6fr;">
        <div class="route">
          <div class="title">[${r.driver_id}] ${r.name || ''}</div>
          <div class="subtitle">${r.vehicle ? ('Ve√≠culo: ' + r.vehicle) : ''}</div>
        </div>
        <div class="muted">√öltimo registro: ${fmtTime(r.created_at)}</div>
        <div></div>
      </div>
    `;
    listEl.appendChild(card);
  }
}
document.getElementById('btnShowPresent').onclick = renderPresent;

/* ========= LIMPAR DISPON√çVEIS ========= */
const btnClearPresent = document.getElementById('btnClearPresent');
if (btnClearPresent) {
  btnClearPresent.onclick = async ()=>{
    if(!adminHash){
      await modalAlert('Acesso','Fa√ßa login para executar.');
      return;
    }
    const ok = await modalConfirm(
      'Limpar dispon√≠veis',
      'Isso ir√° remover TODOS os motoristas dispon√≠veis no galp√£o. Deseja continuar?',
      'Limpar',
      'Cancelar',
      true
    );
    if(!ok) return;
    const { error } = await sb.rpc('clear_present_drivers');
    if(error){
      await modalAlert('Erro', error.message || 'Erro ao limpar dispon√≠veis.');
      return;
    }
    await modalAlert('Conclu√≠do','Lista de dispon√≠veis limpa com sucesso.');
    await renderPresent();
  };
}

/* ========= MOTORISTAS (MODAL + PESQUISA) ========= */
let driversCache = [];

function openDriversModal(){
  if(!adminHash){ modalAlert('Acesso','Fa√ßa login para executar.'); return; }
  $('#driversBackdrop').style.display = 'flex';
  $('#driversQuery').focus();

  $('#driversHint').textContent = 'Digite um ID ou nome e clique em Pesquisar.';
  $('#driversSearchList').innerHTML = '';
  $('#driversSearchEmpty').style.display = 'none';
}
function closeDriversModal(){
  $('#driversBackdrop').style.display = 'none';
}

$('#btnShowDrivers').onclick = openDriversModal;
$('#btnCloseDrivers').onclick = closeDriversModal;
$('#btnCloseDrivers2').onclick = closeDriversModal;
$('#driversBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='driversBackdrop') closeDriversModal(); });

function openDriverModal(){
  if(!adminHash){ modalAlert('Acesso','Fa√ßa login para executar.'); return; }
  document.getElementById('driverModalTitle').textContent = 'Adicionar motorista';
  document.getElementById('driverModalHint').textContent = 'Obs: se o Driver ID j√° existir, ele ser√° atualizado e ficar√° ativo.';
  document.getElementById('d_id').disabled = false;
  document.getElementById('d_id').value='';
  document.getElementById('d_name').value='';
  document.getElementById('d_vehicle').value='';
  document.getElementById('driverBackdrop').style.display='flex';
  document.getElementById('d_id').focus();
}
function closeDriverModal(){
  document.getElementById('driverBackdrop').style.display='none';
}

document.getElementById('btnNewDriverTop').onclick = ()=>{
  closeDriversModal();
  openDriverModal();
};
document.getElementById('btnCloseDriver').onclick = closeDriverModal;
document.getElementById('btnCancelDriver').onclick = closeDriverModal;
document.getElementById('driverBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='driverBackdrop') closeDriverModal(); });

function isNumericOnly(s){ return /^[0-9]+$/.test(s); }

async function searchDrivers(query){
  query = (query || '').trim();
  if(!query) return [];

  const base = sb.from('drivers')
    .select('driver_id,name,vehicle,active,created_at')
    .limit(30)
    .order('name',{ascending:true});

  if(isNumericOnly(query)){
    const { data, error } = await base.eq('driver_id', query);
    if(error){ console.error(error); return []; }
    return data || [];
  } else {
    const q = query.replace(/[%_]/g,'');
    const { data, error } = await base.or(`name.ilike.%${q}%,driver_id.ilike.%${q}%`);
    if(error){ console.error(error); return []; }
    return data || [];
  }
}

function renderDriversSearch(list){
  const el = document.getElementById('driversSearchList');
  const empty = document.getElementById('driversSearchEmpty');
  el.innerHTML = '';

  if(!list.length){
    empty.style.display='block';
    return;
  }
  empty.style.display='none';

  for(const d of list){
    const active = d.active !== false;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="row" style="grid-template-columns:1.4fr .7fr 1fr;">
        <div class="route">
          <div class="title">[${d.driver_id}] ${d.name || ''}</div>
          <div class="subtitle">${d.vehicle ? ('Ve√≠culo: '+d.vehicle) : ''}</div>
        </div>

        <div>
          ${active ? `<span class="pill ok">Ativo</span>` : `<span class="pill warn">Desativado</span>`}
        </div>

        <div class="actions">
          <button class="btn-action" data-act="toggle" data-id="${d.driver_id}">
            ${active ? 'Desativar' : 'Ativar'}
          </button>
          <button class="btn-action danger" data-act="del" data-id="${d.driver_id}">
            Excluir
          </button>
        </div>
      </div>
    `;
    el.appendChild(card);
  }

  el.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.onclick = async ()=>{
      if(!adminHash){ await modalAlert('Acesso','Fa√ßa login para executar.'); return; }

      const id = String(btn.dataset.id);
      const act = btn.dataset.act;
      const row = driversCache.find(x=>String(x.driver_id)===id);
      const isActive = row?.active !== false;

      if(act==='toggle'){
        const next = !isActive;
        const ok = await modalConfirm(
          next ? 'Ativar motorista' : 'Desativar motorista',
          `Deseja ${next ? 'ATIVAR' : 'DESATIVAR'} o motorista [${id}] ${row?.name || ''}?`,
          next ? 'Ativar' : 'Desativar',
          'Cancelar',
          !next
        );
        if(!ok) return;

        const { data, error } = await sb.rpc('admin_set_driver_active', {
          p_driver_id: id,
          p_active: next,
          p_passhash: adminHash
        });
        if(error){ await modalAlert('Erro', error.message || 'Falha ao alterar status.'); return; }
        await modalAlert('OK', (data && data[0]?.message) || 'Atualizado.');
        await runDriversSearch();
      }

      if(act==='del'){
        const ok = await modalConfirm(
          'Excluir motorista',
          `Tem certeza que deseja EXCLUIR [${id}] ${row?.name || ''}?<br><br><b>Dica:</b> se quiser s√≥ impedir uso, use "Desativar".`,
          'Excluir',
          'Cancelar',
          true
        );
        if(!ok) return;

        const { data, error } = await sb.rpc('admin_delete_driver', {
          p_driver_id: id,
          p_passhash: adminHash
        });
        if(error){ await modalAlert('Erro', error.message || 'Falha ao excluir.'); return; }
        await modalAlert('OK', (data && data[0]?.message) || 'Exclu√≠do.');
        await runDriversSearch();
      }
    };
  });
}

async function runDriversSearch(){
  const q = $('#driversQuery').value.trim();
  if(!q){
    $('#driversHint').textContent = 'Digite um ID ou nome e clique em Pesquisar.';
    $('#driversSearchList').innerHTML = '';
    $('#driversSearchEmpty').style.display = 'none';
    return;
  }
  $('#driversHint').textContent = 'Pesquisando...';
  driversCache = await searchDrivers(q);

  $('#driversHint').textContent = driversCache.length
    ? `Mostrando ${driversCache.length} resultado(s) (m√°x. 30).`
    : 'Nenhum resultado.';
  renderDriversSearch(driversCache);
}

$('#btnSearchDrivers').onclick = runDriversSearch;
$('#driversQuery').addEventListener('keydown', (e)=>{ if(e.key==='Enter') runDriversSearch(); });

/* SALVAR MOTORISTA */
document.getElementById('btnSaveDriver').onclick = async ()=>{
  if(!adminHash){ await modalAlert('Acesso','Fa√ßa login para executar.'); return; }

  const id = document.getElementById('d_id').value.trim();
  const name = document.getElementById('d_name').value.trim();
  const vehicle = document.getElementById('d_vehicle').value;

  if(!id || !name || !vehicle){
    await modalAlert('Campos obrigat√≥rios','Preencha Driver ID, Nome e Ve√≠culo.');
    return;
  }

  const { data, error } = await sb.rpc('admin_create_driver', {
    p_driver_id: String(id),
    p_name: name,
    p_vehicle: String(vehicle).toUpperCase(),
    p_passhash: adminHash
  });

  if(error){
    await modalAlert('Erro', error.message || 'Falha ao salvar motorista.');
    return;
  }

  closeDriverModal();
  await modalAlert('OK', (data && data[0]?.message) || 'Motorista salvo.');

  $('#driversQuery').value = String(id);
  openDriversModal();
  await runDriversSearch();
};

/* ========= REALTIME ========= */
async function subRealtimeRoutes(){
  if(channelRoutes) sb.removeChannel(channelRoutes);
  channelRoutes = sb.channel('routes-admin', {
    config:{ broadcast:{ack:true}, postgres_changes:{ include_old_record:true } }
  })
  .on('postgres_changes',{event:'*',schema:'public',table:'routes'}, async ()=>{
    renderRoutes(await loadRoutes());
  })
  .subscribe();
}
async function subRealtimePresent(){
  if(channelPresent) sb.removeChannel(channelPresent);
  channelPresent = sb.channel('present-admin', {
    config:{ broadcast:{ack:true}, postgres_changes:{ include_old_record:true } }
  })
  .on('postgres_changes',{event:'*',schema:'public',table:'present_drivers'}, ()=>{
    renderPresent();
  })
  .subscribe();
}

async function initPanel(){
  renderRoutes(await loadRoutes());
  await renderPresent();
  await subRealtimeRoutes();
  await subRealtimePresent();
}
</script>
</body>
</html>
