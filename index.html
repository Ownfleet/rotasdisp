<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin • Rotas</title>

<style>
  /* ========= Design tokens (Shopee vibe) ========= */
  :root{
    --brand:#EE4D2D;
    --brand-2:#FF6A3C;
    --bg:#F7F7F8;
    --card:#FFFFFF;
    --txt:#0F172A;          /* slate-900 */
    --muted:#64748B;        /* slate-500 */
    --line:#E2E8F0;         /* slate-200 */
    --radius:16px;
    --radius-lg:20px;
    --shadow:0 10px 28px rgba(17,24,39,.08);
    --shadow-soft:0 6px 18px rgba(17,24,39,.06);
    --focus-ring:0 0 0 3px rgba(238,77,45,.28);
    --trans:.18s ease;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
    color:var(--txt);
    background:
      radial-gradient(1200px 600px at 100% -10%, rgba(255,106,60,.08), transparent 60%),
      radial-gradient(900px 400px at -10% 0%, rgba(238,77,45,.06), transparent 55%),
      var(--bg);
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }

  /* ========= Topbar ========= */
  .topbar{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(90deg,var(--brand),var(--brand-2));
    color:#fff;
    padding:14px 0;
    box-shadow:var(--shadow);
    border-bottom:1px solid rgba(255,255,255,.2);
  }
  .topbar__inner{
    max-width:1100px; margin:0 auto; padding:0 16px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .brand{display:flex; align-items:center; gap:12px}
  .brand__logo{
    width:40px; height:40px; border-radius:12px;
    background:#fff; display:grid; place-items:center;
    box-shadow:0 6px 18px rgba(0,0,0,.18);
  }
  .brand__title{font-weight:900; font-size:1.1rem; letter-spacing:.2px}

  /* ========= Layout / Card ========= */
  .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius-lg);
    box-shadow:var(--shadow-soft);
    padding:18px;
    transition:box-shadow var(--trans), border-color var(--trans);
  }
  .card:hover{ box-shadow:0 12px 26px rgba(17,24,39,.10); border-color:#dbe3ef }

  /* ========= Table ========= */
  table{width:100%;border-collapse:collapse;border-radius:14px;overflow:hidden}
  thead th{
    background:#FFF1EC; color:#6B7280; font-weight:800;
    padding:12px 14px; text-align:left; border-bottom:1px solid var(--line);
    font-size:.92rem; letter-spacing:.2px;
  }
  tbody td{ padding:14px; border-bottom:1px solid var(--line); vertical-align:middle }
  tbody tr:hover{ background:#fffaf7 }

  /* ========= Chips ========= */
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 12px; border-radius:999px; font-size:.82rem; font-weight:800;
    border:1px solid transparent;
  }
  .chip--ok{ background:#EFFFF7; color:#066E4A; border-color:#BAEBD8 }
  .chip--busy{ background:#FFEDEB; color:#842016; border-color:#FFD3CB }
  .chip--warn{ background:#FFF7E6; color:#7A4E00; border-color:#FFE0A6 }

  /* ========= Buttons ========= */
  .row-actions{display:flex; gap:8px; flex-wrap:wrap}
  .btn{
    padding:10px 14px; border-radius:12px; border:1px solid transparent;
    background:#fff; color:var(--brand); cursor:pointer; font-weight:900; letter-spacing:.2px;
    transition:transform var(--trans), filter var(--trans), box-shadow var(--trans), border-color var(--trans);
    box-shadow:0 2px 8px rgba(2,6,23,.06);
    border:1px solid var(--line);
  }
  .btn:hover{ filter:brightness(.98); transform:translateY(-1px) }
  .btn:active{ transform:translateY(0) scale(.99) }
  .btn:focus-visible{ outline:none; box-shadow:0 6px 20px rgba(17,24,39,.12), var(--focus-ring) }

  .btn--brand{
    background:linear-gradient(180deg,var(--brand),var(--brand-2));
    color:#fff; border:none;
    box-shadow:0 10px 22px rgba(238,77,45,.28);
  }
  .btn--brand:hover{ filter:brightness(.98); transform:translateY(-1px) }
  .btn--danger{
    background:#fff; color:#B91C1C; border:1px solid #FECACA;
  }
  .btn--danger:hover{ background:#FFF5F5 }

  /* ========= Modal ========= */
  .overlay{
    position:fixed; inset:0; background:rgba(15,23,42,.55);
    display:none; align-items:center; justify-content:center; padding:16px;
    backdrop-filter:saturate(140%) blur(2px);
  }
  .modal{
    width:100%; max-width:560px; background:#fff; border-radius:18px;
    box-shadow:0 18px 42px rgba(2,6,23,.22); border:1px solid #E6EAF2; overflow:hidden;
    transform:translateY(8px) scale(.98); opacity:0;
    transition:transform .22s ease, opacity .22s ease;
  }
  .overlay[style*="display: flex"] .modal{ transform:translateY(0) scale(1); opacity:1 }

  .modal__hd{ padding:16px 18px; background:#FFF1EC; border-bottom:1px solid #E6EAF2; font-weight:900 }
  .modal__bd{ padding:18px }
  .modal__ft{ padding:14px 18px; border-top:1px solid #E6EAF2; display:flex; gap:10px; justify-content:flex-end; background:#FAFAFA }
  .close-x{
    position:absolute; right:18px; top:16px; background:transparent; border:none; font-size:22px; cursor:pointer; line-height:1;
    color:#d04b2e;
  }
  .close-x:focus-visible{ outline:none; box-shadow:var(--focus-ring) }

  /* ========= Form fields ========= */
  .field{ display:flex; flex-direction:column; gap:6px; margin:10px 0 }
  .field label{ font-weight:700; font-size:.92rem }
  .field input{
    padding:12px 14px; border:1px solid var(--line); border-radius:12px; font:inherit; background:#fff;
    transition:border-color var(--trans), box-shadow var(--trans);
  }
  .field input::placeholder{ color:#9AA6B2 }
  .field input:focus{ box-shadow:var(--focus-ring); border-color:var(--brand-2); outline:none }

  /* ========= A11y motion ========= */
  @media (prefers-reduced-motion: reduce){
    .btn,.modal{ transition:none }
  }
</style>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

/* ===== Supabase ===== */
const SUPABASE_URL = "https://ypjnykfdtmeovsjctbcu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlwam55a2ZkdG1lb3ZzamN0YmN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NDEyNzksImV4cCI6MjA3MTAxNzI3OX0.h-0z7-ZZWhZihyd4NahEhFtj3FnndTpwbB5-W33P5w4";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:false } });

/* ===== DOM ===== */
const $ = (s)=>document.querySelector(s);
const tbody = $("#tbody");
let currentAdmin = null;

/* ===== Modal helpers ===== */
const overlay = $("#overlay");
const mTitle  = $("#modalTitle");
const mBody   = $("#modalBody");
const mFoot   = $("#modalFoot");
let actionsMap = {};

function closeModal(){
  overlay.style.display = "none";
  mTitle.textContent = ""; mBody.innerHTML = ""; mFoot.innerHTML = "";
  actionsMap = {};
}
function openModal(title, html, actions=[{label:"Fechar",variant:"",id:"close"}]){
  mTitle.textContent = title;
  mBody.innerHTML    = html;
  mFoot.innerHTML    = actions.map((a,i)=>`
    <button class="btn ${a.variant||""}" data-act="${a.id||i}">${a.label}</button>
  `).join("");
  overlay.style.display = "flex";
  actions.forEach((a,i)=>{ actionsMap[a.id||i] = a.onClick || closeModal; });
}
mFoot.addEventListener("click",(e)=>{
  const b = e.target.closest("button[data-act]"); if(!b) return;
  const fn = actionsMap[b.dataset.act]; if(fn) fn();
});
$("#modalClose").addEventListener("click", closeModal);

/* ===== Sessão (30 min) ===== */
const SESSION_KEY = "admin_session";
const SESSION_MS  = 30 * 60 * 1000;

function startSession(email){
  const expiresAt = Date.now() + SESSION_MS;
  localStorage.setItem(SESSION_KEY, JSON.stringify({ email, expiresAt }));
  scheduleExpiry(expiresAt);
}
function scheduleExpiry(expiresAt){
  const ms = Math.max(0, expiresAt - Date.now());
  if (ms === 0) return;
  clearTimeout(window.__sessionTimer);
  window.__sessionTimer = setTimeout(()=>{
    clearSession();
    showMsg("Sessão expirada","Faça login novamente para continuar.");
    openLogin();
  }, ms);
}
function tryResumeSession(){
  const raw = localStorage.getItem(SESSION_KEY);
  if(!raw) return false;
  try{
    const { email, expiresAt } = JSON.parse(raw);
    if(!email || !expiresAt || Date.now() > expiresAt){
      clearSession(); return false;
    }
    currentAdmin = email;
    scheduleExpiry(expiresAt);
    return true;
  }catch{
    clearSession(); return false;
  }
}
function clearSession(){
  localStorage.removeItem(SESSION_KEY);
  currentAdmin = null;
  clearTimeout(window.__sessionTimer);
}

/* ===== Chips ===== */
function statusChip(s, driver_id, driver_nome){
  if(s==="disponivel") return `<span class="chip chip--ok">Disponível</span>`;
  if(s==="pegou" || (s==="indisponivel" && driver_id)){
    return `<span class="chip chip--busy">Rota repassada</span> ${driver_id ? `<small>• [${driver_id}] ${driver_nome||""}</small>` : ""}`;
  }
  return `<span class="chip chip--warn">Indisponível</span>`;
}

/* ===== Tabela ===== */
async function loadRotas(){
  const {data,error}=await supabase.from("rotas").select("*").order("created_at",{ascending:false});
  if(error){ showMsg("Erro", error.message); return; }
  tbody.innerHTML=(data||[]).map(r=>`
    <tr>
      <td><b>${r.label}</b><br><small>${r.regiao}</small></td>
      <td>${statusChip(r.status, r.driver_id, r.driver_nome)}</td>
      <td class="row-actions">
        <button class="btn" data-action="toggle" data-id="${r.id}">${r.status==='disponivel'?'Fechar':'Abrir'}</button>
        <button class="btn btn--danger" data-action="del" data-id="${r.id}">Excluir</button>
      </td>
    </tr>
  `).join("");
}

function showMsg(titulo, mensagem){
  openModal(titulo, `<p>${mensagem}</p>`);
}

/* ===== Ações ===== */
document.addEventListener("click",(e)=>{
  const btn=e.target.closest("[data-action]"); if(!btn) return;
  const id=btn.dataset.id; const action=btn.dataset.action;

  if(action==="new"){
    openModal("Divulgar nova rota", `
      <form id="formNova">
        <div class="field"><label>Rota</label><input name="label" placeholder="ex.: A-3" required></div>
        <div class="field"><label>Região</label><input name="regiao" placeholder="ex.: Jardim Santa Cecília" required></div>
      </form>
    `, [
      {label:"Cancelar", id:"close"},
      {label:"Divulgar", id:"salvar", variant:"btn--brand", onClick: async ()=>{
        const form=$("#formNova");
        const label=form.label.value.trim(); const regiao=form.regiao.value.trim();
        if(!label||!regiao){ showMsg("Atenção","Preencha rota e região."); return; }
        const {error}=await supabase.rpc('admin_insert_rota',{ p_email: currentAdmin, p_label: label, p_regiao: regiao });
        if(error){ showMsg("Erro ao divulgar", error.message); return; }
        closeModal(); await loadRotas(); showMsg("Pronto","Rota divulgada com sucesso.");
      }}
    ]);
  }

  if(action==="toggle"){
    openModal("Alterar status", `<p>Deseja alternar a disponibilidade desta rota?</p>`, [
      {label:"Cancelar", id:"close"},
      {label:"Confirmar", id:"go", variant:"btn--brand", onClick: async ()=>{
        const {error}=await supabase.rpc('admin_toggle_rota_status',{ p_email: currentAdmin, p_rota_id: id });
        closeModal();
        if(error){ showMsg("Erro", error.message); return; }
        await loadRotas(); showMsg("Ok","Status atualizado.");
      }}
    ]);
  }

  if(action==="del"){
    openModal("Excluir rota", `<p>Tem certeza que deseja excluir esta rota?</p>`, [
      {label:"Cancelar", id:"close"},
      {label:"Excluir", id:"delgo", variant:"btn--danger", onClick: async ()=>{
        const {error}=await supabase.rpc('admin_delete_rota',{ p_email: currentAdmin, p_rota_id: id });
        closeModal();
        if(error){ showMsg("Erro", error.message); return; }
        await loadRotas(); showMsg("Pronto","Rota excluída.");
      }}
    ]);
  }
});

/* ===== Login (modal) — sem sugestões do navegador ===== */
function openLogin(){
  openModal("Entrar como admin", `
    <form id="formLogin" autocomplete="off">
      <div class="field">
        <label>E-mail</label>
        <input
          id="email"
          type="email"
          placeholder="seuemail@dominio.com"
          required
          name="nope"                 /* evita histórico salvo */
          autocomplete="off"          /* desativa autocomplete */
          autocapitalize="none"
          autocorrect="off"
          spellcheck="false"
          inputmode="email"
          readonly                    /* bloqueia o dropdown de sugestões */
          onfocus="this.removeAttribute('readonly');"  /* libera a digitação no foco */
        >
      </div>
    </form>
  `, [
    {label:"Sair", id:"close"},
    {label:"Entrar", id:"login", variant:"btn--brand", onClick: async ()=>{
      const email=($("#email").value||"").trim().toLowerCase(); if(!email) return;
      const {data,error}=await supabase.rpc('is_admin',{ p_email: email });
      if(error){ showMsg("Erro ao verificar", error.message); return; }
      if(!data){ showMsg("Acesso negado","Você não tem permissão para acessar."); return; }
      currentAdmin = email;
      startSession(email);
      closeModal();
      await loadRotas();
      supabase.channel('rotas-ch')
        .on('postgres_changes',{event:'*',schema:'public',table:'rotas'},loadRotas)
        .subscribe();
    }}
  ]);
}

/* ===== Boot ===== */
window.addEventListener("DOMContentLoaded", async ()=>{
  if (tryResumeSession()){
    await loadRotas();
    supabase.channel('rotas-ch')
      .on('postgres_changes',{event:'*',schema:'public',table:'rotas'},loadRotas)
      .subscribe();
  } else {
    openLogin();
  }
});
</script>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="topbar__inner">
      <div class="brand" aria-label="Shopee">
        <div class="brand__logo" aria-hidden="true">
          <!-- Logo Shopee (bag icon) -->
          <svg viewBox="0 0 48 48" width="28" height="28" aria-hidden="true">
            <defs>
              <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#EE4D2D"/>
                <stop offset="1" stop-color="#FF6A3C"/>
              </linearGradient>
            </defs>
            <rect x="0" y="0" width="48" height="48" rx="12" fill="url(#g)"></rect>
            <path fill="#fff" d="M15 20.8c0-1.21.98-2.2 2.2-2.2h13.6c1.21 0 2.2.99 2.2 2.2V33c0 1.66-1.34 3-3 3H18c-1.66 0-3-1.34-3-3V20.8zm6.5-5.1a2.5 2.5 0 015 0v1.3h2.5v-1.3a5 5 0 10-10 0v1.3H21.5v-1.3z"></path>
          </svg>
        </div>
        <div class="brand__title">Rotas • Admin</div>
      </div>
      <button class="btn btn--brand" data-action="new">Nova rota</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h3 style="margin:0 0 12px;font-size:1.05rem">Rotas publicadas</h3>
      <table role="table" aria-label="Tabela de rotas publicadas">
        <thead>
          <tr>
            <th style="width:45%">Rota</th>
            <th style="width:25%">Status</th>
            <th style="width:30%">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal único -->
  <div id="overlay" class="overlay" aria-modal="true" role="dialog">
    <div class="modal" role="document" aria-labelledby="modalTitle" aria-describedby="modalBody">
      <button id="modalClose" class="close-x" aria-label="Fechar">×</button>
      <div class="modal__hd" id="modalTitle"></div>
      <div class="modal__bd" id="modalBody"></div>
      <div class="modal__ft" id="modalFoot"></div>
    </div>
  </div>
</body>
</html>
