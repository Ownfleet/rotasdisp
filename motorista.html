<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rotas dispon√≠veis</title>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- Leaflet p/ o mini-mapa -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    /* Paleta Dark Luxo */
    --bg:#020617;
    --bg-soft:#050816;
    --glass:#050816cc;
    --glass-strong:#0b1220e6;
    --ink:#e5e7eb;
    --ink-soft:#9ca3af;

    --brand:#ff6a3c;
    --brand-soft:#ff8b61;
    --accent:#f97316;

    --stroke:rgba(148,163,184,.35);
    --stroke-soft:rgba(55,65,81,.75);
    --shadow-lg:0 30px 80px rgba(0,0,0,.85);
    --shadow-sm:0 18px 40px rgba(15,23,42,.9);

    --ok:#22c55e;
    --warn:#eab308;
    --danger:#f97373;

    --chip-blue-from:#0b1220;
    --chip-blue-to:#111827;
    --chip-blue-text:#bfdbfe;
    --chip-gold-from:#1f1305;
    --chip-gold-to:#2b1806;
    --chip-gold-text:#fde68a;
    --chip-green-from:#031a12;
    --chip-green-to:#05241a;
    --chip-green-text:#bbf7d0;

    --r-card:24px;
    --r-btn:14px;
    --r-chip:999px;
  }

  *{
    box-sizing:border-box;
    -webkit-tap-highlight-color:transparent;
  }
  html,body{height:100%}
  body{
    margin:0;
    color:var(--ink);
    font:15px/1.6 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial;
    background:
      radial-gradient(900px 600px at -10% 0%, rgba(248,113,113,.22), transparent 55%),
      radial-gradient(900px 600px at 110% -10%, rgba(251,146,60,.18), transparent 55%),
      var(--bg);
  }

  /* Appbar */
  .appbar{
    position:sticky; top:0; z-index:30;
    background:linear-gradient(135deg,#020617f9,#020617f9);
    border-bottom:1px solid rgba(15,23,42,.9);
    box-shadow:0 18px 60px rgba(0,0,0,.85);
    backdrop-filter:blur(26px);
  }
  .appbar .inner{
    max-width:1200px;
    margin:0 auto;
    padding:12px 20px 14px;
    display:flex;
    align-items:center;
    gap:14px;
  }

  .logo{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .logo .badge{
    display:flex;
    align-items:center;
    justify-content:center;
    height:40px;
    padding:0 14px;
    border-radius:999px;
    background:radial-gradient(circle at 0% 0%,#ffffff,#e5e7eb);
    box-shadow:0 10px 30px rgba(0,0,0,.7);
    border:1px solid rgba(148,163,184,.6);
  }
  .logo img.brand{
    height:22px;
    width:auto;
    display:block;
    object-fit:contain;
  }
  .appbar-title{
    font-size:16px;
    font-weight:800;
    letter-spacing:.08em;
    text-transform:uppercase;
  }

  .spacer{flex:1}

  .btn-here{
    padding:9px 15px;
    border-radius:999px;
    border:1px solid rgba(248,250,252,.18);
    background:radial-gradient(circle at 0% 0%,#f9fafb,#e5e7eb);
    color:#111827;
    font-weight:800;
    font-size:12px;
    letter-spacing:.09em;
    text-transform:uppercase;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:8px;
    box-shadow:0 14px 40px rgba(0,0,0,.85);
    transform-origin:center;
    transition:
      box-shadow .18s ease,
      transform .12s ease,
      filter .16s ease,
      border-color .16s ease;
  }
  .btn-here::before{
    content:"‚óè";
    font-size:10px;
    color:#22c55e;
  }
  .btn-here:hover{
    transform:translateY(-1px) scale(1.02);
    box-shadow:0 18px 55px rgba(0,0,0,1);
    filter:brightness(1.02);
    border-color:rgba(248,250,252,.6);
  }
  .btn-here:active{
    transform:translateY(0) scale(.99);
    box-shadow:0 10px 32px rgba(0,0,0,.9);
  }

  /* Layout principal */
  .wrap{
    max-width:1200px;
    margin:22px auto 32px;
    padding:0 18px 24px;
  }

  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
    gap:20px;
  }

  /* Card de rota */
  .card{
    position:relative;
    isolation:isolate;
    border-radius:var(--r-card);
    background:
      radial-gradient(circle at -10% 0%,rgba(248,113,113,.12),transparent 60%),
      radial-gradient(circle at 120% 0%,rgba(251,146,60,.10),transparent 55%),
      var(--glass-strong);
    border:1px solid rgba(31,41,55,.95);
    box-shadow:var(--shadow-lg);
    overflow:hidden;
    padding:18px 18px 16px;
    backdrop-filter:blur(26px) saturate(145%);
    transition:
      transform .16s ease,
      box-shadow .2s ease,
      border-color .18s ease,
      background .18s ease;
  }
  .card::before{
    content:"";
    position:absolute;
    inset:-40px -40px auto -40px;
    height:90px;
    background:radial-gradient(circle at 0% 0%,rgba(248,250,252,.38),transparent 60%);
    opacity:.85;
    z-index:-1;
  }
  .card:hover{
    transform:translateY(-4px) translateZ(0);
    box-shadow:0 32px 80px rgba(0,0,0,1);
    border-color:rgba(248,250,252,.25);
  }

  .ribbon{
    position:absolute;
    top:14px;
    right:-42px;
    rotate:8deg;
    pointer-events:none;
    padding:6px 52px;
    border-radius:999px;
    border:1px solid rgba(15,23,42,.45);
    font-weight:800;
    letter-spacing:.16em;
    text-transform:uppercase;
    font-size:10px;
    backdrop-filter: blur(16px);
    box-shadow:0 10px 30px rgba(0,0,0,.9);
  }
  .ribbon.ok{
    background:linear-gradient(90deg,rgba(34,197,94,.30),rgba(22,163,74,.12));
    color:#bbf7d0;
    border-color:rgba(34,197,94,.65);
  }
  .ribbon.warn{
    background:linear-gradient(90deg,rgba(234,179,8,.32),rgba(251,191,36,.14));
    color:#fef3c7;
    border-color:rgba(250,204,21,.7);
  }
  .ribbon.mine{
    background:linear-gradient(90deg,rgba(59,130,246,.32),rgba(37,99,235,.16));
    color:#dbeafe;
    border-color:rgba(59,130,246,.75);
  }

  .title{
    font-size:18px;
    font-weight:800;
    margin:0 0 4px;
    letter-spacing:.04em;
    text-transform:uppercase;
  }

  /* üî• REGI√ÉO MAIOR E MAIS LEG√çVEL */
  .sub{
    color:#ffffff;
    font-size:20px;
    font-weight:700;
    margin:4px 0 18px;
    letter-spacing:.3px;
    text-shadow:0 0 8px rgba(0,0,0,.55);
  }

  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:14px;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:7px 11px;
    border-radius:var(--r-chip);
    font-weight:700;
    font-size:11px;
    border:1px solid transparent;
    box-shadow:inset 0 -1px rgba(0,0,0,.4);
  }
  .chip span.dot{
    width:7px;
    height:7px;
    border-radius:999px;
    background:currentColor;
    opacity:.85;
  }
  .chip.blue{
    background:linear-gradient(180deg,var(--chip-blue-from),var(--chip-blue-to));
    color:var(--chip-blue-text);
    border-color:rgba(59,130,246,.8);
  }
  .chip.gold{
    background:linear-gradient(180deg,var(--chip-gold-from),var(--chip-gold-to));
    color:var(--chip-gold-text);
    border-color:rgba(234,179,8,.9);
  }
  .chip.green{
    background:linear-gradient(180deg,var(--chip-green-from),var(--chip-green-to));
    color:var(--chip-green-text);
    border-color:rgba(22,163,74,.9);
  }

  .btn{
    width:100%;
    padding:13px 16px;
    border-radius:var(--r-btn);
    background:linear-gradient(135deg,var(--brand-soft),var(--brand));
    color:#f9fafb;
    border:1px solid rgba(248,250,252,.16);
    font-weight:800;
    letter-spacing:.12em;
    font-size:11px;
    text-transform:uppercase;
    box-shadow:
      0 18px 40px rgba(248,113,113,.75),
      0 0 0 1px rgba(15,23,42,.9) inset;
    cursor:pointer;
    transition:
      transform .08s ease,
      box-shadow .18s ease,
      filter .18s ease,
      opacity .18s ease,
      border-color .16s ease;
  }
  .btn:hover{
    box-shadow:
      0 22px 55px rgba(248,113,113,1),
      0 0 0 1px rgba(15,23,42,1) inset;
    transform:translateY(-1px);
    filter:brightness(1.03);
  }
  .btn:active{
    transform:translateY(0);
    filter:brightness(.97);
    box-shadow:
      0 14px 32px rgba(248,113,113,.9),
      0 0 0 1px rgba(15,23,42,1) inset;
  }
  .btn[disabled]{
    opacity:.5;
    cursor:not-allowed;
    filter:grayscale(.2);
    box-shadow:none;
    background:linear-gradient(180deg,#020617,#020617);
    border-color:rgba(55,65,81,.85);
    color:#6b7280;
  }

  .callout{
    margin-top:10px;
    padding:9px 11px;
    border-radius:14px;
    background:rgba(22,163,74,.14);
    border:1px dashed rgba(22,163,74,.6);
    color:#bbf7d0;
    font-size:12px;
    display:flex;
    gap:6px;
    align-items:flex-start;
  }
  .callout::before{
    content:"‚úì";
    font-weight:900;
    margin-top:1px;
  }

  /* Estado vazio */
  .empty{
    margin:46px auto;
    max-width:720px;
    text-align:center;
    color:var(--ink-soft);
    background:var(--glass);
    border:1px dashed rgba(55,65,81,.9);
    border-radius:24px;
    padding:26px 22px 24px;
    box-shadow:var(--shadow-sm);
    backdrop-filter: blur(22px) saturate(140%);
  }
  .empty h3{
    margin:0 0 6px;
    font-size:18px;
    color:var(--ink);
    text-transform:uppercase;
    letter-spacing:.14em;
  }
  .empty p{
    margin:0;
    font-size:13px;
  }

  /* Modais */
  .backdrop{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:40;
    background:radial-gradient(circle at 10% -10%,rgba(248,113,113,.18),transparent 55%),
               radial-gradient(circle at 110% 0%,rgba(251,146,60,.16),transparent 55%),
               rgba(0,0,0,.70);
    backdrop-filter: blur(18px);
  }
  .modal{
    width:min(640px,92vw);
    background:var(--glass-strong);
    border:1px solid var(--stroke-soft);
    border-radius:22px;
    box-shadow:0 30px 80px rgba(0,0,0,1);
    overflow:hidden;
    animation:pop .18s ease-out;
    backdrop-filter: blur(26px) saturate(150%);
  }
  @keyframes pop{
    from{transform:translateY(14px) scale(.97); opacity:0}
    to{transform:translateY(0) scale(1); opacity:1}
  }
  .m-head{
    padding:14px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid rgba(31,41,55,.95);
    background:radial-gradient(circle at 0% 0%,rgba(248,250,252,.12),transparent 55%);
  }
  .m-head h3{
    margin:0;
    font-size:15px;
    font-weight:700;
    letter-spacing:.08em;
    text-transform:uppercase;
  }
  .m-body{
    padding:18px 18px 14px;
  }
  .m-foot{
    padding:12px 18px 14px;
    display:flex;
    gap:10px;
    justify-content:flex-end;
    border-top:1px solid rgba(31,41,55,.95);
    background:radial-gradient(circle at 100% 0%,rgba(248,250,252,.06),transparent 55%);
  }

  label{
    font-size:11px;
    color:var(--ink-soft);
    display:block;
    margin-bottom:5px;
    font-weight:600;
    letter-spacing:.14em;
    text-transform:uppercase;
  }
  input{
    width:100%;
    padding:11px 13px;
    border:1px solid rgba(75,85,99,.9);
    border-radius:14px;
    background:#020617;
    outline:none;
    font-size:14px;
    color:var(--ink);
    transition:border-color .14s ease, box-shadow .14s ease, background .12s;
  }
  input::placeholder{
    color:#6b7280;
    font-size:13px;
  }
  input:focus{
    box-shadow:
      0 0 0 1px rgba(248,250,252,.2),
      0 0 0 4px rgba(248,113,113,.4);
    border-color:rgba(248,250,252,.9);
    background:#020617;
  }

  .btn-sec,
  .btn-prim{
    border-radius:999px;
    padding:9px 16px;
    font-size:13px;
    font-weight:700;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
    transition:
      background .14s ease,
      transform .08s ease,
      box-shadow .14s ease,
      color .12s ease,
      border-color .12s ease;
  }
  .btn-sec{
    background:transparent;
    color:var(--ink-soft);
    border:1px solid rgba(55,65,81,.9);
  }
  .btn-sec:hover{
    background:rgba(31,41,55,.85);
    transform:translateY(-1px);
  }
  .btn-prim{
    background:linear-gradient(135deg,var(--brand-soft),var(--brand));
    color:#f9fafb;
    border:1px solid rgba(248,250,252,.22);
    box-shadow:0 16px 38px rgba(248,113,113,.75);
  }
  .btn-prim:hover{
    box-shadow:0 20px 52px rgba(248,113,113,1);
    transform:translateY(-1px);
  }
  .btn-prim:active{
    transform:translateY(0);
    box-shadow:0 12px 30px rgba(248,113,113,.9);
  }

  .muted{
    color:var(--ink-soft);
    font-size:12px;
  }

  /* Toast */
  .toast{
    position:fixed;
    right:18px;
    bottom:18px;
    z-index:60;
    color:#e5e7eb;
    background:#020617;
    padding:10px 13px;
    border-radius:12px;
    box-shadow:0 18px 48px rgba(0,0,0,1);
    display:none;
    font-size:13px;
    max-width:280px;
    border:1px solid rgba(75,85,99,.9);
    animation:toast-in .18s ease-out;
  }
  @keyframes toast-in{
    from{opacity:0; transform:translateY(8px) translateZ(0);}
    to{opacity:1; transform:translateY(0) translateZ(0);}
  }

  /* Modal de progresso + mini-mapa */
  .geo-box{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  #locMap{
    width:100%;
    height:240px;
    border-radius:16px;
    border:1px solid rgba(55,65,81,.9);
    overflow:hidden;
  }
  .progress{
    height:9px;
    border-radius:999px;
    background:#020617;
    overflow:hidden;
    border:1px solid rgba(55,65,81,.9);
  }
  .progress > div{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,var(--brand-soft),var(--brand));
    transition:width .18s ease-out;
  }
  .status{
    font-weight:700;
    font-size:13px;
  }
  .result.ok{color:var(--ok);}
  .result.err{color:var(--danger);}

  /* Responsivo */
  @media (max-width:600px){
    .appbar .inner{padding-inline:14px;}
    .btn-here{padding-inline:12px; font-size:11px;}
    .wrap{padding-inline:14px;}
    .card{padding:16px 14px 14px;}
    .title{font-size:17px;}
  }
</style>
</head>
<body>
<header class="appbar">
  <div class="inner">
    <div class="logo">
      <span class="badge">
        <img class="brand" src="https://wp.logos-download.com/wp-content/uploads/2024/09/Shopee_Express_Logo-3000x474.png" alt="Shopee Express">
      </span>
      <div class="appbar-title">Rotas dispon√≠veis</div>
    </div>
    <div class="spacer"></div>
    <button id="btnHere" class="btn-here">Estou no galp√£o</button>
  </div>
</header>

<main class="wrap">
  <div id="empty" class="empty" style="display:none">
    <h3>SEM ROTAS</h3>
    <p>Quando novas rotas forem divulgadas, elas aparecem aqui automaticamente.</p>
  </div>
  <div id="grid" class="grid"></div>
</main>

<!-- Modal Pegar rota -->
<div class="backdrop" id="backdrop">
  <div class="modal">
    <div class="m-head">
      <h3 id="mTitle">Pegar rota</h3>
      <button class="btn-sec" id="mClose">Fechar</button>
    </div>
    <div class="m-body">
      <div style="margin-bottom:12px;font-size:13px;"><b id="mRegion"></b></div>
      <label for="driverId">Seu ID Shopee</label>
      <input id="driverId" placeholder="Digite seu ID exatamente como est√° no cadastro">
      <div class="muted" style="margin-top:8px;">
        O ID ser√° salvo neste dispositivo para facilitar nos pr√≥ximos acessos.
      </div>
    </div>
    <div class="m-foot">
      <button class="btn-sec" id="mCancel">Cancelar</button>
      <button class="btn-prim" id="mConfirm">Confirmar</button>
    </div>
  </div>
</div>

<!-- Modal ‚ÄúEstou no galp√£o‚Äù -->
<div class="backdrop" id="hereBackdrop" style="display:none">
  <div class="modal">
    <div class="m-head">
      <h3>Estou no galp√£o</h3>
      <button class="btn-sec" id="hereClose">Fechar</button>
    </div>
    <div class="m-body">
      <label for="hereDriver">Seu ID Shopee</label>
      <input id="hereDriver" placeholder="Digite seu ID para registrar presen√ßa">
      <div class="muted" style="margin-top:10px;">
        Usaremos sua localiza√ß√£o apenas para confirmar que voc√™ est√° pr√≥ximo ao galp√£o.
      </div>
    </div>
    <div class="m-foot">
      <button class="btn-sec" id="hereCancel">Cancelar</button>
      <button class="btn-prim" id="hereConfirm">Confirmar presen√ßa</button>
    </div>
  </div>
</div>

<!-- Modal de progresso + mini-mapa -->
<div class="backdrop" id="geoBackdrop" style="display:none">
  <div class="modal">
    <div class="m-head">
      <h3>Confirmando presen√ßa‚Ä¶</h3>
      <button class="btn-sec" id="geoClose">Fechar</button>
    </div>
    <div class="m-body">
      <div class="geo-box">
        <div id="locMap"></div>
        <div class="progress"><div id="geoBar"></div></div>
        <div class="status" id="geoStatus">Obtendo sua localiza√ß√£o‚Ä¶</div>
        <div id="geoDist" class="muted"></div>
        <div id="geoResult" class=""></div>
      </div>
    </div>
    <div class="m-foot">
      <button class="btn-sec" id="geoOk" style="display:none">OK</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== Supabase ===== */
const SUPABASE_URL = 'https://rtuxwydhgucdqbmyuhbt.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0dXh3eWRoZ3VjZHFibXl1aGJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTQyOTEsImV4cCI6MjA3NTM5MDI5MX0._69KQdPbipke-jVmF_UEO3VAYaiEqpa1h81jUVTN684';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== helpers ===== */
const $ = s => document.querySelector(s);

function toast(msg, ms=2200){
  const t = $('#toast');
  t.textContent = msg;
  t.style.display = 'block';
  t.style.opacity = '1';
  t.style.transform = 'translateY(0)';
  setTimeout(()=>{
    t.style.opacity = '0';
    t.style.transform = 'translateY(6px)';
    setTimeout(()=>{
      t.style.display='none';
      t.style.opacity='1';
      t.style.transform='translateY(0)';
    }, 180);
  }, ms);
}

const chip = v => {
  if(v === 'PASSEIO') return `<span class="chip blue"><span class="dot"></span>PASSEIO</span>`;
  if(v === 'FIORINO') return `<span class="chip gold"><span class="dot"></span>FIORINO</span>`;
  return `<span class="chip green"><span class="dot"></span>MOTO</span>`;
};

/* Geofence (UX). Servidor valida tamb√©m */
const HUB = { lat: -23.4228742608968, lng: -46.52296978566112 };
const RADIUS_M = 250;
const toRad = v => v*Math.PI/180;

/* ===== state ===== */
let channel=null, currentRoute=null, map=null, circle=null, you=null;

/* ===== data ===== */
async function fetchRoutes(){
  const { data, error } = await sb
    .from('routes')
    .select('id, cluster, region, vehicle_allowed, claimed_driver_id, created_at')
    .order('created_at',{ascending:false});

  if(error){
    console.error(error);
    toast('Erro ao carregar rotas.');
    return [];
  }
  return data || [];
}

/* ===== UI ===== */
function ribbonFor(r, myId){
  if(r.claimed_driver_id){
    if(myId && r.claimed_driver_id === myId) return `<div class="ribbon mine">VOC√ä PEGOU</div>`;
    return `<div class="ribbon warn">ROTA REPASSADA</div>`;
  }
  return `<div class="ribbon ok">DISPON√çVEL</div>`;
}

async function render(){
  const grid = $('#grid');
  grid.innerHTML = '';
  const empty = $('#empty');
  const rows = await fetchRoutes();

  if(!rows.length){
    empty.style.display='block';
    return;
  }
  empty.style.display='none';

  const myId = localStorage.getItem('driver_id') || '';

  // Dispon√≠veis primeiro, depois rotas j√° repassadas; dentro disso, mais novas primeiro
  rows.sort((a,b)=>{
    const avA = a.claimed_driver_id?1:0, avB = b.claimed_driver_id?1:0;
    if(avA !== avB) return avA - avB;
    return new Date(b.created_at) - new Date(a.created_at);
  });

  rows.forEach(r=>{
    const claimed = !!r.claimed_driver_id;
    const isMine  = claimed && myId && (r.claimed_driver_id === myId);
    const card = document.createElement('article');
    card.className='card';
    card.innerHTML = `
      ${ribbonFor(r, myId)}
      <h3 class="title">Rota: ${r.cluster || '-'}</h3>
      <p class="sub">Regi√£o: ${r.region || ''}</p>
      <div class="chips">${(r.vehicle_allowed||[]).map(chip).join('')}</div>
      <button class="btn" data-id="${r.id}" data-title="${r.cluster||'-'}" data-region="${r.region||''}" ${claimed?'disabled':''}>
        ${claimed ? (isMine ? 'Voc√™ j√° pegou' : 'Indispon√≠vel') : 'Pegar rota'}
      </button>
      ${isMine ? `<div class="callout">Voc√™ pegou esta rota. <b>Procure o analista para confirmar o carregamento.</b></div>` : ''}
    `;
    if(!claimed) card.querySelector('button').onclick = openModal;
    grid.appendChild(card);
  });
}

/* ===== modal pegar rota ===== */
function openModal(ev){
  const btn = ev.currentTarget;
  currentRoute = {
    id:Number(btn.dataset.id),
    title:btn.dataset.title,
    region:btn.dataset.region
  };
  $('#mTitle').textContent = `Pegar rota ${currentRoute.title}`;
  $('#mRegion').textContent = `Regi√£o: ${currentRoute.region}`;
  $('#driverId').value = localStorage.getItem('driver_id') || '';
  $('#backdrop').style.display='flex';
}
function closeModal(){ $('#backdrop').style.display='none'; }
$('#mClose').onclick = closeModal;
$('#mCancel').onclick = closeModal;

$('#mConfirm').onclick = async ()=>{
  if(!currentRoute) return;
  const driverId = $('#driverId').value.trim();
  if(!driverId){
    toast('Informe seu ID.');
    return;
  }
  const { data, error } = await sb.rpc('claim_route', {
    p_route_id: currentRoute.id,
    p_driver_id: driverId
  });
  if(error){
    toast('Erro ao pegar rota: '+(error.message||''));
    return;
  }
  const res = data && data[0] ? data[0] : { success:false, message:'Falha ao pegar rota.' };
  toast(res.message || 'Opera√ß√£o conclu√≠da.');
  if(res.success) localStorage.setItem('driver_id', driverId);
  closeModal();
  await render();
};

/* ===== modal presen√ßa no galp√£o ===== */
const hereBd = $('#hereBackdrop');
const hereOpen = ()=>{
  $('#hereDriver').value = localStorage.getItem('driver_id') || '';
  hereBd.style.display='flex';
};
const hereClose = ()=> hereBd.style.display='none';
$('#btnHere').onclick = hereOpen;
$('#hereClose').onclick = hereClose;
$('#hereCancel').onclick = hereClose;

/* ===== modal de progresso/mapa ===== */
const geoBd = $('#geoBackdrop'),
      geoBar = $('#geoBar'),
      geoStatus = $('#geoStatus'),
      geoDist = $('#geoDist'),
      geoResult = $('#geoResult'),
      geoOk = $('#geoOk');

$('#geoClose').onclick = ()=> geoBd.style.display='none';
geoOk.onclick = ()=> geoBd.style.display='none';

function setProgress(p){
  geoBar.style.width = Math.max(0, Math.min(100, p)) + '%';
}

function initMap(center){
  if(!map){
    map = L.map('locMap',{ zoomControl:false, attributionControl:false });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  }
  map.setView(center, 16);
  if(circle){ circle.remove(); }
  circle = L.circle([HUB.lat,HUB.lng], {
    radius:RADIUS_M,
    color:'#fb923c',
    fillColor:'#fb923c',
    fillOpacity:.15
  }).addTo(map);
  if(you){ you.remove(); }
  you = L.marker(center).addTo(map);
}

$('#hereConfirm').onclick = async ()=>{
  const driverId = $('#hereDriver').value.trim();
  if(!driverId){
    toast('Informe seu ID.');
    return;
  }
  if(!('geolocation' in navigator)){
    toast('Seu navegador n√£o permite localiza√ß√£o.');
    return;
  }

  // abre o modal de progresso
  geoBd.style.display='flex';
  geoResult.className='';
  geoResult.textContent='';
  geoDist.textContent='';
  geoOk.style.display='none';
  setProgress(20);
  geoStatus.textContent='Obtendo sua localiza√ß√£o‚Ä¶';
  hereClose();

  navigator.geolocation.getCurrentPosition(async (pos)=>{
    setProgress(55);
    geoStatus.textContent='Localiza√ß√£o obtida. Verificando dist√¢ncia‚Ä¶';
    const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    initMap(coords);

    // dist√¢ncia (UX)
    const R=6371000,
          dLat=toRad(coords.lat-HUB.lat),
          dLng=toRad(coords.lng-HUB.lng);
    const s = Math.sin(dLat/2)**2 +
              Math.cos(toRad(HUB.lat))*Math.cos(toRad(coords.lat))*
              Math.sin(dLng/2)**2;
    const d = 2*R*Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
    geoDist.textContent = `Dist√¢ncia at√© o galp√£o: ${Math.round(d)} m`;

    setProgress(75);
    geoStatus.textContent='Registrando presen√ßa‚Ä¶';

    // RPC valida ID + raio
    const { data, error } = await sb.rpc('mark_present', {
      p_driver_id: driverId,
      p_lat: coords.lat,
      p_lng: coords.lng
    });

    setProgress(100);
    if(error){
      geoStatus.textContent = 'Erro ao registrar.';
      geoResult.className='result err';
      geoResult.textContent = error.message || 'Falha ao registrar presen√ßa.';
      geoOk.style.display='inline-flex';
      return;
    }

    const res = data && data[0] ? data[0] : { success:false, message:'Falha ao registrar presen√ßa.' };
    geoStatus.textContent = res.success ? 'Tudo certo!' : 'N√£o foi poss√≠vel confirmar.';
    geoResult.className = res.success ? 'result ok' : 'result err';
    geoResult.textContent = res.message || (res.success?'Presen√ßa registrada.':'Falha ao registrar presen√ßa.');
    if(res.success) localStorage.setItem('driver_id', driverId);
    geoOk.style.display='inline-flex';
  }, (err)=>{
    setProgress(100);
    geoStatus.textContent = 'N√£o foi poss√≠vel obter a localiza√ß√£o.';
    geoResult.className='result err';
    geoResult.textContent = err?.message || 'Permita o acesso √† localiza√ß√£o e tente novamente.';
    geoOk.style.display='inline-flex';
  }, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
};

/* ===== realtime ===== */
async function subRealtime(){
  if(channel) sb.removeChannel(channel);
  channel = sb
    .channel('routes-driver')
    .on('postgres_changes',{event:'*',schema:'public',table:'routes'}, render)
    .subscribe();
}

/* init */
(async function(){
  await render();
  await subRealtime();
})();
</script>
</body>
</html>
